<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quáº£n lÃ½ Ä‘iá»ƒm danh & Client</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    input, button { padding: 5px; margin: 3px; }
    .section { margin-bottom: 40px; }
    .highlight { background-color: #e3ffe3; }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0.9;
      z-index: 999;
      animation: fadeInOut 3s ease-in-out forwards;
    }
    pre#logOutput {
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ccc;
      max-height: 300px;
      overflow: auto;
      white-space: pre-wrap;
      margin-top: 10px;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(20px); }
      10% { opacity: 0.9; transform: translateY(0); }
      90% { opacity: 0.9; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(20px); }
    }
  </style>
</head>
<body>
  <h1>ğŸ“‹ Quáº£n lÃ½ Ä‘iá»ƒm danh</h1>
  <div class="section">
    <button onclick="loadExcel()"> Danh sÃ¡ch</button>
    <button onclick="location.reload()">Táº£i láº¡i giao diá»‡n</button>
    <button onclick="loadQRLog()">ğŸ“„ Hiá»ƒn thá»‹ QR log</button>
    <button onclick="loadDisplayLog()">ğŸ“„ Hiá»ƒn thá»‹ Display log</button>

    <pre id="logOutput">(ChÆ°a cÃ³ ná»™i dung hiá»ƒn thá»‹)</pre>

    <table id="excelTable">
      <thead>
        <tr>
          <th>STT</th><th>TÃªn</th><th>Giá»›i TÃ­nh</th><th>Chá»©c Vá»¥</th><th>ÄÆ¡n Vá»‹</th><th>Loáº¡i ÄB</th><th>Thá»i Gian</th><th>Thao tÃ¡c</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>â• ThÃªm ngÆ°á»i Ä‘iá»ƒm danh</h3>
    <input placeholder="TÃªn" id="ten">
    <input placeholder="Giá»›i tÃ­nh" id="gt">
    <input placeholder="Chá»©c vá»¥" id="cv">
    <input placeholder="ÄÆ¡n vá»‹" id="dv">
    <input placeholder="Loáº¡i ÄB" id="ldb">
    <button onclick="addRow()">ThÃªm</button>
  </div>

  <h1>ğŸ’» Duyá»‡t káº¿t ná»‘i Client</h1>
  <div class="section">
    <button onclick="loadClients()">LÃ m má»›i danh sÃ¡ch client</button>
    <ul id="clientList"></ul>
  </div>

  <script>
    function showToast(message, color = "#333") {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.style.backgroundColor = color;
      toast.innerText = message;
      document.body.appendChild(toast);
      setTimeout(() => document.body.removeChild(toast), 3000);
    }

    async function loadExcel() {
      try {
        const res = await fetch('/get_excel');
        const data = await res.json();
        const tbody = document.querySelector('#excelTable tbody');
        tbody.innerHTML = '';
        data.forEach(row => {
          const tr = document.createElement('tr');
          row.forEach((cell, idx) => {
            const td = document.createElement('td');
            if (idx === 0 || idx === 6) td.textContent = cell;
            else td.innerHTML = `<input value="${cell}" onchange="updateRow(${row[0]}, ${idx}, this.value)">`;
            tr.appendChild(td);
          });
          const tdDel = document.createElement('td');
          tdDel.innerHTML = `<button onclick="deleteRow(${row[0]})">ğŸ—‘ï¸ XoÃ¡</button>`;
          tr.appendChild(tdDel);
          tbody.appendChild(tr);
        });
      } catch {
        showToast("âŒ Lá»—i táº£i dá»¯ liá»‡u Excel", "crimson");
        console.log("[!] KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u Excel");
      }
    }

    async function updateRow(stt, col, value) {
      await fetch('/update_excel', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ stt, col, value })
      });
      showToast("âœ… ÄÃ£ cáº­p nháº­t");
      console.log(`[=] ÄÃ£ cáº­p nháº­t dÃ²ng ${stt}, cá»™t ${col}`);
    }

    async function deleteRow(stt) {
      await fetch('/delete_excel', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ stt })
      });
      loadExcel();
      showToast("ğŸ—‘ï¸ ÄÃ£ xoÃ¡");
      console.log(`[-] ÄÃ£ xoÃ¡ dÃ²ng STT ${stt}`);
    }

    async function addRow() {
      const body = {
        ten: document.getElementById('ten').value,
        gioi_tinh: document.getElementById('gt').value,
        chuc_vu: document.getElementById('cv').value,
        don_vi: document.getElementById('dv').value,
        loai_db: document.getElementById('ldb').value,
      };
      await fetch('/add_excel', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      loadExcel();
      showToast("âœ… ÄÃ£ thÃªm");
      console.log(`[+] ÄÃ£ thÃªm ngÆ°á»i: ${body.ten}`);
    }

    async function loadClients() {
      try {
        const res = await fetch('/get_clients');
        const data = await res.json();
        const ul = document.getElementById('clientList');
        ul.innerHTML = '';
        data.pending.forEach(ip => {
          const li = document.createElement('li');
          li.innerHTML = `${ip} - <button onclick="approve('${ip}')">âœ… Duyá»‡t</button> <button onclick="deny('${ip}')">âŒ Tá»« chá»‘i</button>`;
          ul.appendChild(li);
        });
        data.allowed.forEach(ip => {
          const li = document.createElement('li');
          li.innerHTML = `${ip} - <button onclick="disconnect('${ip}')">ğŸ”Œ Ngáº¯t káº¿t ná»‘i</button>`;
          li.classList.add("highlight");
          ul.appendChild(li);
        });
      } catch {
        showToast("âŒ Lá»—i táº£i client", "crimson");
        console.log("[!] KhÃ´ng thá»ƒ táº£i danh sÃ¡ch client");
      }
    }

    async function approve(ip) {
      await fetch('/approve_client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip })
      });
      loadClients();
      showToast(`âœ… ÄÃ£ duyá»‡t ${ip}`);
    }

    async function deny(ip) {
      await fetch('/deny_client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip })
      });
      loadClients();
      showToast(`ğŸš« ÄÃ£ tá»« chá»‘i ${ip}`, "#ff4444");
    }

    async function disconnect(ip) {
      await fetch('/disconnect_client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip })
      });
      loadClients();
      showToast(`ğŸ”Œ ÄÃ£ ngáº¯t káº¿t ná»‘i ${ip}`);
    }

    async function loadQRLog() {
      try {
        const res = await fetch('/get_qr_log');
        const data = await res.json();
        if (data.status === "ok") {
          document.getElementById('logOutput').textContent = data.lines.join("");
          showToast("âœ… ÄÃ£ táº£i QR log");
        } else {
          throw new Error(data.message);
        }
      } catch (e) {
        showToast("âŒ Lá»—i khi táº£i QR log", "crimson");
        console.error("[!] QR log error:", e);
      }
    }

    async function loadDisplayLog() {
      try {
        const res = await fetch('/get_display_log');
        const data = await res.json();
        if (data.status === "ok") {
          document.getElementById('logOutput').textContent = data.lines.join("");
          showToast("âœ… ÄÃ£ táº£i Display log");
        } else {
          throw new Error(data.message);
        }
      } catch (e) {
        showToast("âŒ Lá»—i khi táº£i display log", "crimson");
        console.error("[!] Display log error:", e);
      }
    }

    const ws = new WebSocket(`ws://${location.hostname}:8000/ws`);
    ws.onmessage = (event) => {
      showToast(event.data, "#2196f3");
      console.log("[WS] Nháº­n:", event.data);
    };

    window.onload = () => {
      loadExcel();
      loadClients();
    };
  </script>
</body>
</html>
